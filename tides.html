<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<title>Tides ‚Äì Forgeron Weather</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  padding:20px;
  background:#020617;
  color:#e5e7eb;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
}

h1{
  text-align:center;
  margin-bottom:6px;
}

.subtitle{
  text-align:center;
  color:#9ca3af;
  margin-bottom:20px;
}

.card{
  max-width:800px;
  margin:0 auto;
  background:#0b1220;
  border-radius:12px;
  padding:16px;
  box-shadow:0 0 30px rgba(56,189,248,.25);
}

select{
  width:100%;
  padding:8px;
  margin-bottom:12px;
  background:#020617;
  color:#9ca3af;
  border:1px solid rgba(255,255,255,.15);
  border-radius:6px;
}

.tide-row{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px solid rgba(255,255,255,.05);
}

.label{ color:#9ca3af; }

.value{ color:#38bdf8; font-weight:700; }

.footer{
  text-align:center;
  margin-top:30px;
  color:#64748b;
  font-size:12px;
}
</style>
</head>

<body>

<h1>Tidal Forecast</h1>
<div class="subtitle">Simple daily tides</div>

<div class="card">
<div id="tideHeader" style="margin-bottom:14px;">
  <div id="stationName" style="font-size:20px;font-weight:700;"></div>
  <div id="todayDate" style="color:#9ca3af;"></div>
</div>
<!-- STATE DROPDOWN -->
<select id="stateSelect">
  <option value="">Select State</option>
  <option value="WA">Washington</option>
<option value="OR" selected>Oregon</option>
  <option value="CA">California</option>
  <option value="HI">Hawaii</option>
</select>

<!-- CITY DROPDOWN -->
<select id="citySelect" disabled>
  <option value="">Select City</option>
</select>

<div id="tideData">
  Loading‚Ä¶
</div>

</div>

<div class="footer">
‚Üê <a href="index.html" style="color:#38bdf8">Back to Dashboard</a>
</div>

<script>
const tideBox = document.getElementById("tideData");
const stateSelect = document.getElementById("stateSelect");
const citySelect = document.getElementById("citySelect");
const stationNameBox = document.getElementById("stationName");
const todayDateBox = document.getElementById("todayDate");
async function loadTides(){

  tideBox.innerHTML = "Loading‚Ä¶";

const station = citySelect.value;
// Set station name
stationNameBox.textContent =
  citySelect.options[citySelect.selectedIndex].text;

// Set today's date
const todayReadable = new Date().toLocaleDateString(undefined,{
  weekday:"long",
  month:"long",
  day:"numeric"
});
todayDateBox.textContent = todayReadable;
  const d = new Date();
  const today =
    d.getFullYear().toString() +
    String(d.getMonth()+1).padStart(2,"0") +
    String(d.getDate()).padStart(2,"0");

  const url =
    "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter" +
    "?product=predictions" +
    "&application=forgeron" +
    "&begin_date=" + today +
    "&range=24" +
    "&datum=MLLW" +
    "&station=" + station +
    "&time_zone=lst_ldt" +
    "&units=english" +
   "&interval=15" +
    "&format=json";

  try{

    const r = await fetch(url);
    const j = await r.json();
    // get high/low data for summary + list
const hiloUrl =
  "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter" +
  "?product=predictions" +
  "&application=forgeron" +
  "&begin_date=" + today +
  "&range=24" +
  "&datum=MLLW" +
  "&station=" + station +
  "&time_zone=lst_ldt" +
  "&units=english" +
  "&interval=hilo" +
  "&format=json";

const hiloResponse = await fetch(hiloUrl);
const hiloJson = await hiloResponse.json();
// Fallback if 15-min data not available
if(!j.predictions || j.predictions.length === 0){
  const fallbackUrl =
    "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter" +
    "?product=predictions" +
    "&application=forgeron" +
    "&begin_date=" + today +
    "&range=24" +
    "&datum=MLLW" +
    "&station=" + station +
    "&time_zone=lst_ldt" +
    "&units=english" +
    "&interval=hilo" +
    "&format=json";

  const fallbackResponse = await fetch(fallbackUrl);
  const fallbackJson = await fallbackResponse.json();
  j.predictions = fallbackJson.predictions;
}
    tideBox.innerHTML = "";

    const now = new Date();
 
    let nextHigh = null;
    let nextLow = null;

hiloJson.predictions.forEach(p=>{
      const t = new Date(p.t.replace(" ","T"));
      if(t > now){
        if(p.type==="H" && !nextHigh) nextHigh = p;
        if(p.type==="L" && !nextLow) nextLow = p;
      }
    });
   // Determine rising or falling
let trend = "‚Äî";

if(nextHigh && nextLow){
  const nextHighTime = new Date(nextHigh.t.replace(" ","T"));
  const nextLowTime = new Date(nextLow.t.replace(" ","T"));
  

  trend = nextHighTime < nextLowTime ? "Rising" : "Falling";
}
    const summary = document.createElement("div");
    summary.style.marginBottom="14px";
    summary.style.paddingBottom="10px";
    summary.style.borderBottom="1px solid rgba(255,255,255,.1)";

 summary.innerHTML = `
  <div style="font-size:20px;margin-bottom:10px;">
    üåä <strong>${trend}</strong>
  </div>

  <div style="font-size:18px;margin-bottom:6px;">
    <strong>Next High:</strong> ${
      nextHigh ? nextHigh.t.slice(11,16)+" ‚Ä¢ "+nextHigh.v+" ft" : "‚Äî"
    }
  </div>

  <div style="font-size:18px;">
    <strong>Next Low:</strong> ${
      nextLow ? nextLow.t.slice(11,16)+" ‚Ä¢ "+nextLow.v+" ft" : "‚Äî"
    }
  </div>
`;

    tideBox.appendChild(summary);
// Container for tide chart
const chartWrap = document.createElement("div");
chartWrap.id = "tideChart";
chartWrap.style.marginTop = "16px";
tideBox.appendChild(chartWrap);
hiloJson.predictions.forEach(t=>{

  const row = document.createElement("div");
  row.className="tide-row";

  const tideTime = new Date(t.t.replace(" ","T"));
  const isFuture = tideTime > now;

  // Highlight next tide, dim past tides
  if(isFuture && !row.classList.contains("nextTide")){
    row.style.fontWeight="700";
    row.style.color="#38bdf8";
  }else if(!isFuture){
    row.style.opacity=".4";
  }

  row.innerHTML = `
    <span class="label">${t.type==="H"?"High Tide":"Low Tide"} ‚Äì ${t.t.slice(11,16)}</span>
    <span class="value">${t.v} ft</span>
  `;

  tideBox.appendChild(row);

});
drawTideChart(j.predictions);
  }catch(e){
    console.error(e);
    tideBox.innerHTML="Tide data unavailable";
  }

}
function drawTideChart(predictions){

  const wrap = document.getElementById("tideChart");
  wrap.innerHTML = "";

  const width = 800;
  const height = 240;
  const pad = 40;

  const pts = predictions.map(p=>{
    return {
      t:new Date(p.t.replace(" ","T")).getTime(),
      v:parseFloat(p.v)
    };
  });

  const minT=Math.min(...pts.map(p=>p.t));
  const maxT=Math.max(...pts.map(p=>p.t));
  const minV=Math.min(...pts.map(p=>p.v));
  const maxV=Math.max(...pts.map(p=>p.v));

  const x=t=>pad+(t-minT)/(maxT-minT)*(width-2*pad);
  const y=v=>height-pad-(v-minV)/(maxV-minV)*(height-2*pad);

  // Smooth curve
  let d=`M ${x(pts[0].t)} ${y(pts[0].v)}`;
  for(let i=1;i<pts.length;i++){
    const xc=(x(pts[i-1].t)+x(pts[i].t))/2;
    const yc=(y(pts[i-1].v)+y(pts[i].v))/2;
    d+=` Q ${x(pts[i-1].t)} ${y(pts[i-1].v)} ${xc} ${yc}`;
  }

  const now=Date.now();

 // Interpolate tide level at current time
let before = pts[0];
let after = pts[pts.length-1];

for(let i=0;i<pts.length-1;i++){
  if(pts[i].t <= now && pts[i+1].t >= now){
    before = pts[i];
    after = pts[i+1];
    break;
  }
}

let interpV = before.v;

if(after.t !== before.t){
  const ratio = (now - before.t) / (after.t - before.t);
  interpV = before.v + ratio * (after.v - before.v);
}

const nowX = x(Math.min(Math.max(now,minT),maxT));
const nowY = y(interpV);
const nowFt = interpV.toFixed(1);

  // 6 local time labels
  let timeLabels="";
  for(let i=0;i<6;i++){
    const t=minT+(i/5)*(maxT-minT);
    const dte=new Date(t);
    const lbl=dte.toLocaleTimeString([], {hour:"numeric"});
    const lx=x(t);
    timeLabels+=`<text x="${lx-8}" y="${height-8}" fill="#94a3b8" font-size="10">${lbl}</text>`;
  }

  wrap.innerHTML=`
<svg viewBox="0 0 ${width} ${height}" width="100%" height="${height}">

<defs>
<filter id="glow">
  <feGaussianBlur stdDeviation="4" result="blur"/>
  <feMerge>
    <feMergeNode in="blur"/>
    <feMergeNode in="SourceGraphic"/>
  </feMerge>
</filter>
</defs>

<!-- axes -->
<line x1="${pad}" x2="${pad}" y1="${pad}" y2="${height-pad}" stroke="#334155"/>
<line x1="${pad}" x2="${width-pad}" y1="${height-pad}" y2="${height-pad}" stroke="#334155"/>

<!-- y labels -->
<text x="4" y="${y(maxV)+4}" fill="#94a3b8" font-size="10">${maxV.toFixed(1)}ft</text>
<text x="4" y="${y(minV)+4}" fill="#94a3b8" font-size="10">${minV.toFixed(1)}ft</text>

${timeLabels}

<!-- glow line -->
<path d="${d}" stroke="#38bdf8" stroke-width="3" fill="none" filter="url(#glow)"/>

<!-- main line -->
<path d="${d}" stroke="#38bdf8" stroke-width="1.5" fill="none"/>



<!-- NOW label -->
<text
  x="${nowX}"
  y="${nowY-22}"
  text-anchor="middle"
  fill="#ffffff"
  font-size="11"
  style="text-shadow:0 0 6px #38bdf8">
  NOW ${nowFt} ft
</text>

</svg>`;
}
stateSelect.onchange = ()=>{

  citySelect.innerHTML = '<option value="">Select City</option>';
if(stateSelect.value==="OR"){

  citySelect.innerHTML += '<option value="9439040">Astoria, OR</option>';
  citySelect.innerHTML += '<option value="9432373">Bandon, OR</option>';
  citySelect.innerHTML += '<option value="9432780">Brookings, OR</option>';
  citySelect.innerHTML += '<option value="9439040">Cannon Beach, OR</option>';
  citySelect.innerHTML += '<option value="9432780">Coos Bay, OR</option>';
  citySelect.innerHTML += '<option value="9437540">Garibaldi, OR</option>';
  citySelect.innerHTML += '<option value="9430104">Gold Beach, OR</option>';
  citySelect.innerHTML += '<option value="9435385">Lincoln City, OR</option>';
  citySelect.innerHTML += '<option value="9439040">Manzanita, OR</option>';
  citySelect.innerHTML += '<option value="9439040">Nehalem, OR</option>';
  citySelect.innerHTML += '<option value="9435385">Newport, OR</option>';
  citySelect.innerHTML += '<option value="9432780">North Bend, OR</option>';
  citySelect.innerHTML += '<option value="9437540">Pacific City, OR</option>';
  citySelect.innerHTML += '<option value="9431647">Port Orford, OR</option>';
  citySelect.innerHTML += '<option value="9432780">Reedsport, OR</option>';
  citySelect.innerHTML += '<option value="9439040">Seaside, OR</option>';
  citySelect.innerHTML += '<option value="9437540">Tillamook, OR</option>';
  citySelect.innerHTML += '<option value="9439040">Tolovana Park, OR</option>';
  citySelect.innerHTML += '<option value="9435385">Waldport, OR</option>';
  citySelect.innerHTML += '<option value="9432780">Winchester Bay, OR</option>';
  citySelect.innerHTML += '<option value="9435385">Yachats, OR</option>';

}

  citySelect.disabled = !stateSelect.value;
};
  citySelect.onchange = loadTides;
  // Default to Astoria on page load
stateSelect.value = "OR";
stateSelect.onchange();

citySelect.value = "9439040"; // Astoria
loadTides();
</script>


</body>
</html>
