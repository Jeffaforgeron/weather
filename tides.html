<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<title>Tides ‚Äì Forgeron Weather</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  padding:20px;
  background:#020617;
  color:#e5e7eb;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
}

h1{
  text-align:center;
  margin-bottom:6px;
}

.subtitle{
  text-align:center;
  color:#9ca3af;
  margin-bottom:20px;
}

.card{
  max-width:800px;
  margin:0 auto;
  background:#0b1220;
  border-radius:12px;
  padding:16px;
  box-shadow:0 0 30px rgba(56,189,248,.25);
}

select{
  width:100%;
  padding:8px;
  margin-bottom:12px;
  background:#020617;
  color:#9ca3af;
  border:1px solid rgba(255,255,255,.15);
  border-radius:6px;
}

.tide-row{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  border-bottom:1px solid rgba(255,255,255,.05);
}

.label{ color:#9ca3af; }

.value{ color:#38bdf8; font-weight:700; }

.footer{
  text-align:center;
  margin-top:30px;
  color:#64748b;
  font-size:12px;
}
</style>
</head>

<body>

<h1>Tidal Forecast</h1>
<div class="subtitle">Simple daily tides</div>

<div class="card">
<div id="tideHeader" style="margin-bottom:14px;">
  <div id="stationName" style="font-size:20px;font-weight:700;"></div>
  <div id="todayDate" style="color:#9ca3af;"></div>
  <div id="moonPhase" style="color:#94a3b8;font-size:13px;margin-top:4px;"></div>
</div>
<!-- STATE DROPDOWN -->
<select id="stateSelect">
  <option value="">Select State</option>
  <option value="WA">Washington</option>
<option value="OR" selected>Oregon</option>
  <option value="CA">California</option>
  <option value="HI">Hawaii</option>
</select>

<!-- CITY DROPDOWN -->
<select id="citySelect" disabled>
  <option value="">Select City</option>
</select>

<div id="tideData">
  Loading‚Ä¶
</div>

</div>

<div class="footer">
‚Üê <a href="index.html" style="color:#38bdf8">Back to Dashboard</a>
</div>

<script>
// City ‚Üí nearest swell buoy
const swellBuoyMap = {

  // OREGON
  "Astoria, OR":"46029",
  "Cannon Beach, OR":"46029",
  "Seaside, OR":"46029",
  "Manzanita, OR":"46029",
  "Nehalem, OR":"46029",

  "Lincoln City, OR":"46089",
  "Newport, OR":"46089",
  "Waldport, OR":"46089",
  "Yachats, OR":"46089",

  "Coos Bay, OR":"46015",
  "North Bend, OR":"46015",
  "Bandon, OR":"46015",
  "Reedsport, OR":"46015",

  "Brookings, OR":"46027",
  "Gold Beach, OR":"46027",
  "Port Orford, OR":"46027",

  // WASHINGTON
  "Neah Bay, WA":"46087",
  "La Push, WA":"46087",
  "Port Angeles, WA":"46087",

  "Seattle, WA":"46041",
  "Everett, WA":"46041",
  "Tacoma, WA":"46041",
  "Gig Harbor, WA":"46041",
  "Bremerton, WA":"46041",
  "Anacortes, WA":"46041",
  "Oak Harbor, WA":"46041",

  // CALIFORNIA
  "Crescent City, CA":"46027",

  "Monterey, CA":"46042",
  "Santa Cruz, CA":"46042",
  "Capitola, CA":"46042",

  "Pacifica, CA":"46026",
  "Half Moon Bay, CA":"46026",
  "San Francisco, CA":"46026",

  "Santa Barbara, CA":"46053",
  "Ventura, CA":"46053",

  "Avila Beach, CA":"46011",
  "Pismo Beach, CA":"46011",
  "Morro Bay, CA":"46011",

  "Santa Monica, CA":"46221",
  "Malibu, CA":"46221",
  "Redondo Beach, CA":"46221",
  "Long Beach, CA":"46221",
  "Huntington Beach, CA":"46221",
  "Newport Beach, CA":"46221",
  "Laguna Beach, CA":"46221",

  "Oceanside, CA":"46224",
  "Carlsbad, CA":"46224",

  "San Diego, CA":"46232",
  "Dana Point, CA":"46232",
  "La Jolla, CA":"46232",

  // HAWAII
  "Honolulu, HI":"51000",
  "Pearl Harbor, HI":"51000",
  "Waianae, HI":"51000",

  "Kahului, HI":"51003",
  "Lahaina, HI":"51003",

  "Hilo, HI":"51002",
  "Kealakekua, HI":"51002",
  "Kawaihae, HI":"51002",

  "Nawiliwili, HI":"51001",
  "Port Allen, HI":"51001"
};
const tideBox = document.getElementById("tideData");
const stateSelect = document.getElementById("stateSelect");
const citySelect = document.getElementById("citySelect");
const stationNameBox = document.getElementById("stationName");
const todayDateBox = document.getElementById("todayDate");
  const moonBox = document.getElementById("moonPhase");

function getMoonPhase(){

  const now = new Date();
  const synodicMonth = 29.53058867;
  const knownNewMoon = new Date("2000-01-06T18:14:00Z");

  const daysSince =
    (now - knownNewMoon) / 86400000;

  const phase = (daysSince % synodicMonth) / synodicMonth;

  if(phase < 0.03) return "üåë New Moon";
  if(phase < 0.22) return "üåí Waxing Crescent";
  if(phase < 0.28) return "üåì First Quarter";
  if(phase < 0.47) return "üåî Waxing Gibbous";
  if(phase < 0.53) return "üåï Full Moon";
  if(phase < 0.72) return "üåñ Waning Gibbous";
  if(phase < 0.78) return "üåó Last Quarter";
  return "üåò Waning Crescent";
}
async function loadTides(){

  tideBox.innerHTML = "Loading‚Ä¶";

const station = citySelect.value;
  const cityName = citySelect.options[citySelect.selectedIndex].text;
const buoy = swellBuoyMap[cityName];
  // fetch swell data
let swellData = [];

if(buoy){
  try{
    const swellResp = await fetch(
      `https://www.ndbc.noaa.gov/data/realtime2/${buoy}.spec`
    );
    const swellText = await swellResp.text();

    swellText.split("\n").slice(2,50).forEach(l=>{
      const p=l.trim().split(/\s+/);
      if(p.length>8){
        swellData.push({
          t:new Date(`${p[0]}-${p[1]}-${p[2]}T${p[3]}:00Z`).getTime(),
          h:parseFloat(p[8])
        });
      }
    });
  }catch{}
}
// Set station name
stationNameBox.textContent =
  citySelect.options[citySelect.selectedIndex].text;

// Set today's date
const todayReadable = new Date().toLocaleDateString(undefined,{
  weekday:"long",
  month:"long",
  day:"numeric"
});
todayDateBox.textContent = todayReadable;
  moonBox.textContent = getMoonPhase();
  const d = new Date();
  const today =
    d.getFullYear().toString() +
    String(d.getMonth()+1).padStart(2,"0") +
    String(d.getDate()).padStart(2,"0");

  const url =
    "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter" +
    "?product=predictions" +
    "&application=forgeron" +
    "&begin_date=" + today +
    "&range=36" +
    "&datum=MLLW" +
    "&station=" + station +
    "&time_zone=lst_ldt" +
    "&units=english" +
   "&interval=15" +
    "&format=json";

  try{

    const r = await fetch(url);
    const j = await r.json();
    
    // get high/low data for summary + list
const hiloUrl =
  "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter" +
  "?product=predictions" +
  "&application=forgeron" +
  "&begin_date=" + today +
  "&range=36" +
  "&datum=MLLW" +
  "&station=" + station +
  "&time_zone=lst_ldt" +
  "&units=english" +
  "&interval=hilo" +
  "&format=json";

const hiloResponse = await fetch(hiloUrl);
const hiloJson = await hiloResponse.json();
    // fallback for stations without 15-min data
if(!j.predictions || j.predictions.length < 10){
  j.predictions = hiloJson.predictions;
}

    tideBox.innerHTML = "";

    const now = new Date();
 
    let nextHigh = null;
    let nextLow = null;

hiloJson.predictions.forEach(p=>{
      const t = new Date(p.t.replace(" ","T"));
      if(t > now){
        if(p.type==="H" && !nextHigh) nextHigh = p;
        if(p.type==="L" && !nextLow) nextLow = p;
      }
    });
   // Determine rising or falling
let trend = "‚Äî";

if(nextHigh && nextLow){
  const nextHighTime = new Date(nextHigh.t.replace(" ","T"));
  const nextLowTime = new Date(nextLow.t.replace(" ","T"));
  

  trend = nextHighTime < nextLowTime ? "Rising" : "Falling";
}
    const summary = document.createElement("div");
    summary.style.marginBottom="14px";
    summary.style.paddingBottom="10px";
    summary.style.borderBottom="1px solid rgba(255,255,255,.1)";

 summary.innerHTML = `
  <div style="font-size:20px;margin-bottom:10px;">
    üåä <strong>${trend}</strong>
  </div>

  <div style="font-size:18px;margin-bottom:6px;">
    <strong>Next High:</strong> ${
      nextHigh ? nextHigh.t.slice(11,16)+" ‚Ä¢ "+nextHigh.v+" ft" : "‚Äî"
    }
  </div>

  <div style="font-size:18px;">
    <strong>Next Low:</strong> ${
      nextLow ? nextLow.t.slice(11,16)+" ‚Ä¢ "+nextLow.v+" ft" : "‚Äî"
    }
  </div>
`;

    tideBox.appendChild(summary);
// Container for tide chart
const chartWrap = document.createElement("div");
chartWrap.id = "tideChart";
chartWrap.style.marginTop = "16px";
tideBox.appendChild(chartWrap);
hiloJson.predictions.forEach(t=>{

  const row = document.createElement("div");
  row.className="tide-row";

  const tideTime = new Date(t.t.replace(" ","T"));
  const isFuture = tideTime > now;

  // Highlight next tide, dim past tides
  if(isFuture && !row.classList.contains("nextTide")){
    row.style.fontWeight="700";
    row.style.color="#38bdf8";
  }else if(!isFuture){
    row.style.opacity=".4";
  }

  row.innerHTML = `
    <span class="label">${t.type==="H"?"High Tide":"Low Tide"} ‚Äì ${t.t.slice(11,16)}</span>
    <span class="value">${t.v} ft</span>
  `;

  tideBox.appendChild(row);

});
drawTideChart(j.predictions, swellData);
  }catch(e){
    console.error(e);
    tideBox.innerHTML="Tide data unavailable";
  }

}
function drawTideChart(predictions, swell){

  const wrap = document.getElementById("tideChart");
  wrap.innerHTML = "";

  const width = 800;
  const height = 240;
  const pad = 40;

  const pts = predictions.map(p=>{
    return {
      t:new Date(p.t.replace(" ","T")).getTime(),
      v:parseFloat(p.v)
    };
  });

  const minT=Math.min(...pts.map(p=>p.t));
  const maxT=Math.max(...pts.map(p=>p.t));
  const minV=Math.min(...pts.map(p=>p.v));
  const maxV=Math.max(...pts.map(p=>p.v));

  const x=t=>pad+(t-minT)/(maxT-minT)*(width-2*pad);
  const y=v=>height-pad-(v-minV)/(maxV-minV)*(height-2*pad);

  // Smooth curve
  let d=`M ${x(pts[0].t)} ${y(pts[0].v)}`;
  for(let i=1;i<pts.length;i++){
    const xc=(x(pts[i-1].t)+x(pts[i].t))/2;
    const yc=(y(pts[i-1].v)+y(pts[i].v))/2;
    d+=` Q ${x(pts[i-1].t)} ${y(pts[i-1].v)} ${xc} ${yc}`;
  }

  const now=Date.now();

 // Interpolate tide level at current time
let before = pts[0];
let after = pts[pts.length-1];

for(let i=0;i<pts.length-1;i++){
  if(pts[i].t <= now && pts[i+1].t >= now){
    before = pts[i];
    after = pts[i+1];
    break;
  }
}

let interpV = before.v;

if(after.t !== before.t){
  const ratio = (now - before.t) / (after.t - before.t);
  interpV = before.v + ratio * (after.v - before.v);
}

const nowX = x(Math.min(Math.max(now,minT),maxT));
const nowY = y(interpV);
const nowFt = interpV.toFixed(1);

  // 6 local time labels
  let timeLabels="";
  for(let i=0;i<6;i++){
    const t=minT+(i/5)*(maxT-minT);
    const dte=new Date(t);
    const lbl=dte.toLocaleTimeString([], {hour:"numeric"});
    const lx=x(t);
    timeLabels+=`<text x="${lx-8}" y="${height-8}" fill="#94a3b8" font-size="10">${lbl}</text>`;
  }

  wrap.innerHTML=`
<svg viewBox="0 0 ${width} ${height}" width="100%" height="${height}">

<defs>
<filter id="glow">
  <feGaussianBlur stdDeviation="4" result="blur"/>
  <feMerge>
    <feMergeNode in="blur"/>
    <feMergeNode in="SourceGraphic"/>
  </feMerge>
</filter>
</defs>

<!-- axes -->
<line x1="${pad}" x2="${pad}" y1="${pad}" y2="${height-pad}" stroke="#334155"/>
<line x1="${pad}" x2="${width-pad}" y1="${height-pad}" y2="${height-pad}" stroke="#334155"/>

<!-- Y grid lines + labels -->
${[0, 0.33, 0.66, 1].map(p => {
  const val = minV + p * (maxV - minV);
  const yPos = y(val);
  return `
    <line x1="${pad}" x2="${width-pad}" y1="${yPos}" y2="${yPos}"
      stroke="#1e293b" stroke-width="1" opacity="0.3"/>
    <text x="4" y="${yPos+4}" fill="#94a3b8" font-size="10">
      ${val.toFixed(1)} ft
    </text>
  `;
}).join("")}
<!-- Vertical grid lines -->
${[0,1,2,3,4,5].map(i=>{
  const t=minT+(i/5)*(maxT-minT);
  const lx=x(t);
  return `
    <line x1="${lx}" x2="${lx}" y1="${pad}" y2="${height-pad}"
      stroke="#1e293b" stroke-width="1" opacity="0.25"/>
  `;
}).join("")}
${timeLabels}

<!-- glow line -->
<path d="${d}" stroke="#38bdf8" stroke-width="3" fill="none" filter="url(#glow)"/>

<!-- main line -->
<path d="${d}" stroke="#38bdf8" stroke-width="1.5" fill="none"/>



<!-- NOW label -->
<text
  x="${nowX}"
  y="${nowY-22}"
  text-anchor="middle"
  fill="#ffffff"
  font-size="11"
  style="text-shadow:0 0 6px #38bdf8">
  NOW ${nowFt} ft
</text>

</svg>`;
}
stateSelect.onchange = ()=>{

  citySelect.innerHTML = '<option value="">Select City</option>';

  const stations = {

    OR: [
      ["Astoria, OR","9439040"],
      ["Bandon, OR","9432373"],
      ["Brookings, OR","9432780"],
      ["Cannon Beach, OR","9439040"],
      ["Coos Bay, OR","9432780"],
      ["Garibaldi, OR","9437540"],
      ["Gold Beach, OR","9430104"],
      ["Lincoln City, OR","9435385"],
      ["Manzanita, OR","9439040"],
      ["Nehalem, OR","9439040"],
      ["Newport, OR","9435385"],
      ["North Bend, OR","9432780"],
      ["Pacific City, OR","9437540"],
      ["Port Orford, OR","9431647"],
      ["Reedsport, OR","9432780"],
      ["Seaside, OR","9439040"],
      ["Tillamook, OR","9437540"],
      ["Tolovana Park, OR","9439040"],
      ["Waldport, OR","9435385"],
      ["Winchester Bay, OR","9432780"],
      ["Yachats, OR","9435385"]
    ],

    WA: [
      ["Anacortes, WA","9449424"],
      ["Bellingham, WA","9440910"],
      ["Bremerton, WA","9445958"],
      ["Des Moines, WA","9447769"],
      ["Everett, WA","9447130"],
      ["Gig Harbor, WA","9446484"],
      ["La Push, WA","9442396"],
      ["Neah Bay, WA","9441102"],
      ["Oak Harbor, WA","9449274"],
      ["Port Angeles, WA","9444090"],
      ["Port Ludlow, WA","9445014"],
      ["Port Orchard, WA","9445441"],
      ["Port Townsend, WA","9443090"],
      ["Seattle, WA","9444900"],
      ["Tacoma, WA","9446484"],
      ["Vashon, WA","9447130"]
    ],

    CA: [
      ["Avila Beach, CA","9413745"],
      ["Capitola, CA","9413450"],
      ["Carlsbad, CA","9410230"],
      ["Crescent City, CA","9412110"],
      ["Dana Point, CA","9410170"],
      ["Half Moon Bay, CA","9414290"],
      ["Huntington Beach, CA","9410660"],
      ["La Jolla, CA","9410230"],
      ["Laguna Beach, CA","9410170"],
      ["Long Beach, CA","9410660"],
      ["Malibu, CA","9410840"],
      ["Monterey, CA","9413450"],
      ["Morro Bay, CA","9413745"],
      ["Newport Beach, CA","9410170"],
      ["Oceanside, CA","9410230"],
      ["Pacifica, CA","9414290"],
      ["Pismo Beach, CA","9413745"],
      ["Redondo Beach, CA","9410660"],
      ["San Diego, CA","9410170"],
      ["San Francisco, CA","9414290"],
      ["Santa Barbara, CA","9411340"],
      ["Santa Cruz, CA","9413450"],
      ["Santa Monica, CA","9410840"],
      ["Ventura, CA","9411340"]
    ],

    HI: [
      ["Hilo, HI","1611400"],
      ["Honolulu, HI","1612340"],
      ["Kahului, HI","1615680"],
      ["Kawaihae, HI","1617433"],
      ["Kealakekua, HI","1617840"],
      ["Lahaina, HI","1615680"],
      ["Nawiliwili, HI","1617760"],
      ["Pearl Harbor, HI","1612340"],
      ["Port Allen, HI","1612480"],
      ["Waianae, HI","1612340"]
    ]

  };

  const state = stateSelect.value;

  if(stations[state]){
    stations[state]
      .sort((a,b)=>a[0].localeCompare(b[0]))
      .forEach(s=>{
        citySelect.innerHTML += `<option value="${s[1]}">${s[0]}</option>`;
      });
  }

  citySelect.disabled = !state;
};
  citySelect.onchange = loadTides;
  // Default to Astoria on page load
stateSelect.value = "OR";
stateSelect.onchange();

citySelect.value = "9439040"; // Astoria
loadTides();
</script>


</body>
</html>
